name: Pull Request Checks

on:
  pull_request:
    types: [labeled]
    branches:
      - main
  pull_request_review:
    types: [submitted]

jobs:
  # Only run if PR has the "run-checks" label
  should-run-checks:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
    steps:
      - name: Check if should run
        id: check
        run: |
          if [[ "${{ github.event.pull_request.base.ref }}" == "main" && "${{ github.event_name }}" == "pull_request_review" && "${{ github.event.review.state }}" == "approved" ]]; then
            echo "should-run=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.action }}" == "labeled" && "${{ github.event.label.name }}" == "run-checks" ]]; then
            echo "should-run=true" >> $GITHUB_OUTPUT
          else
            echo "should-run=false" >> $GITHUB_OUTPUT
          fi

  changes:
    needs: should-run-checks
    if: ${{ needs.should-run-checks.outputs.should-run == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      web: ${{ steps.filter.outputs.web == 'true' || steps.filter.outputs.ci == 'true' }}
      web-client: ${{ steps.filter.outputs.web-client == 'true' || steps.filter.outputs.ci == 'true' }}
      discord-service: ${{ steps.filter.outputs.discord-service == 'true' || steps.filter.outputs.ci == 'true' }}
      has-changes: ${{ steps.filter.outputs.web == 'true' || steps.filter.outputs.web-client == 'true' || steps.filter.outputs.discord-service == 'true' || steps.filter.outputs.ci == 'true' }}
    steps:
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            web:
              - 'web/**'
              - 'packages/**'
            web-client:
              - 'web-client/**'
              - 'packages/common/**'
            discord-service:
              - 'discord-service/**'
              - 'packages/**'
            ci:
              - '.github/**'

  # setup:
  #   needs: changes
  #   if: ${{ needs.changes.outputs.has-change == 'true' }}
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #     - name: Use common setups action
  #       uses: ./.github/actions/common-setups
  #     - name: Save workspace to cache
  #       uses: actions/cache/save@v4
  #       with:
  #         path: |
  #           .yarn/cache
  #           .yarn/install-state.gz
  #           node_modules
  #           */node_modules
  #           packages/common/dist
  #           packages/server-common/dist
  #           packages/mongo/dist
  #         key: workspace-${{ github.sha }}-${{ hashFiles('yarn.lock', 'packages/*/package.json') }}

  single-job:
    needs: changes
    if: ${{ needs.changes.outputs.has-changes == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Use common setups action
        uses: ./.github/actions/common-setups
      - name: Build web
        if: ${{ needs.changes.outputs.web == 'true' }}
        uses: ./.github/actions/build-web
      - name: Test web
        if: ${{ needs.changes.outputs.web == 'true' }}
        uses: ./.github/actions/test-web
        with:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      - name: Build web client
        if: ${{ needs.changes.outputs.web-client == 'true' }}
        uses: ./.github/actions/build-web-client
      - name: Build discord service
        if: ${{ needs.changes.outputs.discord-service == 'true' }}
        uses: ./.github/actions/build-discord-service

  # build-discord-service:
  #   needs: changes
  #   if: ${{ needs.changes.outputs.discord-service == 'true' }}
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #     - name: Use build-discord-service composite action
  #       uses: ./.github/actions/build-discord-service

  # build-web-client:
  #   needs: changes
  #   if: ${{ needs.changes.outputs.web-client == 'true' }}
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #     - name: Use build-web-client composite action
  #       uses: ./.github/actions/build-web-client

  # build-and-test-web:
  #   needs: changes
  #   if: ${{ needs.changes.outputs.web == 'true' }}
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #     - name: Use build-web composite action
  #       uses: ./.github/actions/build-web
  #     - name: Use test-web composite action
  #       uses: ./.github/actions/test-web
  #       with:
  #         CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
  # run-lint:
  #   uses: ./.github/workflows/lint.yml

  # chromatic:
  #   needs: changes
  #   if: ${{ needs.changes.outputs.web-client == 'true' }}
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0

  #     - name: Use Node.js 22.x
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: 22.x
  #         cache: 'yarn'

  #     - name: Use latest yarn version
  #       run: yarn set version stable

  #     - name: Install dependencies
  #       run: yarn install --immutable

  #     - name: Run Chromatic
  #       uses: chromaui/action@latest
  #       with:
  #         projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
  #         workingDir: web-client

  # Remove label after all jobs complete
  cleanup:
    needs: [
        should-run-checks,
        changes,
        single-job,
        # build-and-test-web,
        # build-discord-service,
        # build-web-client,
      ]
    if: ${{ always() && needs.should-run-checks.outputs.should-run == 'true' && github.event_name != 'pull_request_review' }}
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Remove run-checks label
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'run-checks'
              });
              console.log('âœ… Label removed successfully');
            } catch (error) {
              console.log('Label may not exist or already removed');
            }
