name: Deploy to Production (frontend)

on:
  workflow_dispatch:
    inputs:
      commit_hash:
        description: 'Commit hash to deploy'
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: web_client-prod

    steps:
      - name: Checkout specific commit
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.commit_hash }}
          fetch-depth: 0

      - name: Extract and prepare environment variables
        id: extract_vars
        run: |
          # Convert GitHub vars to Render API format
          VARS_JSON=$(echo '${{ toJson(vars) }}' | jq '[to_entries[] | {key: .key, value: (.value | tostring)}]')
          echo "vars_json=$VARS_JSON" >> $GITHUB_OUTPUT

          # Convert GitHub secrets to Render API format (excluding Render-specific secrets)
          SECRETS_JSON=$(echo '${{ toJson(secrets) }}' | jq 'del(.RENDER_API_KEY, .GITHUB_TOKEN) | [to_entries[] | {key: .key, value: .value}]')
          echo "secrets_json=$SECRETS_JSON" >> $GITHUB_OUTPUT

          # Combine vars and secrets for the API call
          COMBINED_ENV=$(echo "$VARS_JSON $SECRETS_JSON" | jq -s 'add')
          echo "combined_env=$COMBINED_ENV" >> $GITHUB_OUTPUT

      - name: Update Render service environment variables
        run: |
          # Update environment variables via Render API
          curl -X PUT \
            "https://api.render.com/v1/services/${{ vars.RENDER_SERVICE_ID }}/env-vars" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '${{ steps.extract_vars.outputs.combined_env }}'

      - name: Trigger Render deployment
        id: deploy
        run: |
          # Trigger deployment via Render API
          DEPLOY_RESPONSE=$(curl -X POST \
            "https://api.render.com/v1/services/${{ vars.RENDER_SERVICE_ID }}/deploys" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "clearCache": "clear"
            }')

          DEPLOY_ID=$(echo "$DEPLOY_RESPONSE" | jq -r '.id')
          echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT
          echo "Deployment ID: $DEPLOY_ID"

      - name: Wait for deployment completion
        run: |
          DEPLOY_ID="${{ steps.deploy.outputs.deploy_id }}"

          echo "Waiting for deployment $DEPLOY_ID to complete..."

          while true; do
            STATUS_RESPONSE=$(curl -s \
              "https://api.render.com/v1/services/${{ vars.RENDER_SERVICE_ID }}/deploys/$DEPLOY_ID" \
              -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}")
            
            STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.status')
            echo "Current status: $STATUS"
            
            case $STATUS in
              "live")
                echo "âœ… Deployment completed successfully!"
                break
                ;;
              "build_failed"|"update_failed"|"canceled")
                echo "âŒ Deployment failed with status: $STATUS"
                exit 1
                ;;
              "created"|"build_in_progress"|"update_in_progress")
                echo "â³ Deployment in progress, waiting 30 seconds..."
                sleep 30
                ;;
              *)
                echo "âš ï¸ Unknown status: $STATUS, continuing to wait..."
                sleep 30
                ;;
            esac
          done

      - name: Get commit info
        id: commit_info
        run: |
          SHORT_HASH=$(git rev-parse --short ${{ inputs.commit_hash }})
          UTC_DATE=$(date -u +"%Y%m%dT%H%M%SZ")
          echo "short_hash=$SHORT_HASH" >> $GITHUB_OUTPUT
          echo "utc_date=$UTC_DATE" >> $GITHUB_OUTPUT

      - name: Create and push tag
        run: |
          TAG_NAME="frontend-prod-${{ steps.commit_info.outputs.utc_date }}-${{ steps.commit_info.outputs.short_hash }}"
          git tag $TAG_NAME ${{ inputs.commit_hash }}
          git push origin $TAG_NAME
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Production Frontend Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: frontend" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ inputs.commit_hash }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: frontend-prod-${{ steps.commit_info.outputs.utc_date }}-${{ steps.commit_info.outputs.short_hash }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: production-frontend" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy ID**: ${{ steps.deploy.outputs.deploy_id }}" >> $GITHUB_STEP_SUMMARY
