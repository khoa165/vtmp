name: Deploy link-processing-service to AWS Lambda
description: Build, push Docker image to ECR, and update Lambda function

inputs:
  aws-access-key-id:
    description: AWS Access Key ID
    required: true
  aws-secret-access-key:
    description: AWS Secret Access Key
    required: true
  aws-region:
    description: AWS Region
    required: true
  ecr-repository:
    description: ECR Repository Name
    required: true
  lambda-function-name:
    description: Lambda Function Name
    required: true

runs:
  using: 'composite'
  steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: ${{ runner.os }}-buildx-

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ inputs.aws-access-key-id }}
        aws-secret-access-key: ${{ inputs.aws-secret-access-key }}
        aws-region: ${{ inputs.aws-region }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build, tag, and push Docker image to ECR
      uses: docker/build-push-action@v6
      with:
        context: .
        file: link-processing-service/Dockerfile
        platforms: linux/amd64
        provenance: false # <--- disables provenance metadata, required for Lambda
        # cache-from: type=local,src=/tmp/.buildx-cache
        # cache-to: type=local,dest=/tmp/.buildx-cache
        push: true
        tags: ${{ steps.login-ecr.outputs.registry }}/${{ inputs.ecr-repository }}:${{ github.sha }}

    - name: Update Lambda function to use new image
      shell: bash
      run: |
        aws lambda update-function-code \
          --function-name ${{ inputs.lambda-function-name }} \
          --image-uri ${{ steps.login-ecr.outputs.registry }}/${{ inputs.ecr-repository }}:${{ github.sha }} \
          --region ${{ inputs.aws-region }}
